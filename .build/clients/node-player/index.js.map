{"version":3,"names":["Client","launcher","loadConfig","createLayout","AudioContext","GainNode","OscillatorNode","mediaDevices","MediaStreamAudioSourceNode","AnalyserNode","Engine","env","bootstrap","config","import","meta","url","client","register","start","players","stateManager","getCollection","globals","attach","audioContext","numChannels","destination","channelCount","channelInterpretation","resume","merger","createChannelMerger","connect","engines","Array","fill","logger","onAttach","player","i","length","engine","onUpdate","render","onDetach","get","getEngineId","disconnect","newValues","execute","numClients","process","EMULATE","parseInt","moduleURL","table","forEach","index","push","freq","id","filter","console","clear","log"],"sources":["../../../src/clients/node-player/index.js"],"sourcesContent":["import '@soundworks/helpers/polyfills.js';\nimport { Client } from '@soundworks/core/client.js';\nimport launcher from '@soundworks/helpers/launcher.js';\n\nimport { loadConfig } from '../../utils/load-config.js';\nimport createLayout from './layout.js';\n\nimport { AudioContext, GainNode, OscillatorNode, mediaDevices, MediaStreamAudioSourceNode, AnalyserNode } from 'node-web-audio-api';\n\nimport Engine from '../components/engine.js';\n\n// - General documentation: https://soundworks.dev/\n// - API documentation:     https://soundworks.dev/api\n// - Issue Tracker:         https://github.com/collective-soundworks/soundworks/issues\n// - Wizard & Tools:        `npx soundworks`\n\nconst env = 'prod';\n\nasync function bootstrap() {\n  // for dev\n  let config;\n  if (env === 'dev') {\n    config = loadConfig('default', import.meta.url);\n  } else {\n    config = loadConfig('remote', import.meta.url);\n  }\n  // for prod\n  const client = new Client(config);\n\n  launcher.register(client);\n\n  /**\n   * Launch application\n   */\n  await client.start();\n\n  const players = await client.stateManager.getCollection('player');\n  const globals = await client.stateManager.attach('globals');\n\n  const audioContext = new AudioContext();\n  const numChannels = 16;\n\n  audioContext.destination.channelCount = numChannels;\n  audioContext.destination.channelInterpretation = 'discrete';\n\n  await audioContext.resume();\n\n  const merger = audioContext.createChannelMerger(numChannels);\n\n  merger.channelInterpretation = 'discrete';\n  merger.connect(audioContext.destination);\n\n  const engines = Array(numChannels).fill(null);\n  const logger = Array(numChannels).fill(null);\n\n  players.onAttach((player) => {\n    // push engine in first free slot\n    for (let i = 0; i < engines.length; i++) {\n      if (engines[i] === null) {\n        const engine = new Engine(audioContext, player, globals);\n        engines[i] = engine;\n        logger[i] = player;\n        engine.connect(merger, 0, i);\n        player.onUpdate(() => {\n          engine.render();\n        })\n        break;\n      }\n    }\n    render(logger);\n  });\n\n  players.onDetach((player) => {\n    for (let i = 0; i < engines.length; i++) {\n      if (engines[i]\n        && player.get('id') === engines[i].getEngineId())\n      {\n        // console.log(`removing engine ${player.get('id')}`)\n        engines[i].disconnect();\n        engines[i] = null;\n        logger[i] = null;\n      }\n    }\n    render(logger);\n  });\n\n  players.onUpdate((player, newValues) => {\n    render(logger);\n  })\n}\n\n// The launcher allows to fork multiple clients in the same terminal window\n// by defining the `EMULATE` env process variable\n// e.g. `EMULATE=10 npm run watch-process thing` to run 10 clients side-by-side\nlauncher.execute(bootstrap, {\n  numClients: process.env.EMULATE ? parseInt(process.env.EMULATE) : 1,\n  moduleURL: import.meta.url,\n});\n\n\nfunction render(logger) {\n  const table = [];\n  logger.forEach((player, index) => {\n    if (player) {\n      table.push({index: index+1, freq: player.get('sawFreq'), id: player.get('id'), filter: player.get('filterFreq')});\n    } else {\n      table.push({index: index+1, freq: null, id: null, filter: null});\n    }\n  })\n  console.clear();\n  if (env === 'dev') {\n    console.log('playing in dev environment');\n  } else {\n    console.log('playing in prod environment');\n  }\n  console.table(table);\n}\n"],"mappings":"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"}
