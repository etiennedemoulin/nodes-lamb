{"version":3,"names":["Client","launcher","loadConfig","createLayout","AudioContext","GainNode","OscillatorNode","mediaDevices","MediaStreamAudioSourceNode","AnalyserNode","Engine","bootstrap","config","process","env","ENV","import","meta","url","client","register","start","players","stateManager","getCollection","audioContext","destination","channelCount","channelCountMode","channelInterpretation","resume","merger","createChannelMerger","connect","chArray","engines","Array","fill","onAttach","player","i","length","engine","onUpdate","$layout","requestUpdate","render","onDetach","get","getEngineId","disconnect","execute","numClients","EMULATE","parseInt","moduleURL"],"sources":["../../../src/clients/node-player/index.js"],"sourcesContent":["import '@soundworks/helpers/polyfills.js';\nimport { Client } from '@soundworks/core/client.js';\nimport launcher from '@soundworks/helpers/launcher.js';\n\nimport { loadConfig } from '../../utils/load-config.js';\nimport createLayout from './layout.js';\n\nimport { AudioContext, GainNode, OscillatorNode, mediaDevices, MediaStreamAudioSourceNode, AnalyserNode } from 'node-web-audio-api';\n\nimport Engine from '../components/engine.js';\n\n// - General documentation: https://soundworks.dev/\n// - API documentation:     https://soundworks.dev/api\n// - Issue Tracker:         https://github.com/collective-soundworks/soundworks/issues\n// - Wizard & Tools:        `npx soundworks`\n\nasync function bootstrap() {\n  /**\n   * Load configuration from config files and create the soundworks client\n   */\n  const config = loadConfig(process.env.ENV, import.meta.url);\n  const client = new Client(config);\n\n  /**\n   * Register some soundworks plugins, you will need to install the plugins\n   * before hand (run `npx soundworks` for help)\n   */\n  // client.pluginManager.register('my-plugin', plugin);\n\n  /**\n   * Register the soundworks client into the launcher\n   *\n   * Automatically restarts the process when the socket closes or when an\n   * uncaught error occurs in the program.\n   */\n  launcher.register(client);\n\n  /**\n   * Launch application\n   */\n  await client.start();\n  const players = await client.stateManager.getCollection('player');\n\n  const audioContext = new AudioContext();\n  audioContext.destination.channelCount = 11;\n  audioContext.destination.channelCountMode = \"explicit\";\n  audioContext.destination.channelInterpretation = \"discrete\";\n  await audioContext.resume();\n\n  const merger = audioContext.createChannelMerger(11); // 11 in, 1 out\n  merger.connect(audioContext.destination);\n\n  const chArray = [0, 1, 2, 3, 9, 10, 6, 7]; // slots\n  const engines = Array(8).fill(null);\n\n  players.onAttach((player) => {\n    // push engine in first free slot\n    for (let i = 0; i < (engines.length - 1); i++) {\n      if (engines[i] === null) {\n        // console.log(`creating engine ${player.get('id')} on slot ${chArray[i]}`)\n        const engine = new Engine(audioContext, player, false);\n        engines[i] = engine;\n        engine.env.connect(merger, 0, chArray[i]);\n        player.onUpdate(() => {\n          $layout.requestUpdate();\n          engine.render();\n        })\n        break;\n      }\n    }\n  });\n\n  players.onDetach((player) => {\n    for (let i = 0; i < (engines.length - 1); i++) {\n      if (engines[i]\n        && player.get('id') === engines[i].getEngineId())\n      {\n        // console.log(`removing engine ${player.get('id')}`)\n        engines[i].env.disconnect();\n        engines[i] = null;\n      }\n    }\n  })\n}\n\n// The launcher allows to fork multiple clients in the same terminal window\n// by defining the `EMULATE` env process variable\n// e.g. `EMULATE=10 npm run watch-process thing` to run 10 clients side-by-side\nlauncher.execute(bootstrap, {\n  numClients: process.env.EMULATE ? parseInt(process.env.EMULATE) : 1,\n  moduleURL: import.meta.url,\n});\n"],"mappings":"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"}
